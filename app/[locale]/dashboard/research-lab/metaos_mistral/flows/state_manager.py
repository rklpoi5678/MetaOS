# State detection and update logic